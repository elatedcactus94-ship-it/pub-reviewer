<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
    .pub-card { 
      background:#fff; 
      margin-bottom:12px; 
      padding:12px; 
      border-radius:10px; 
      box-shadow:0 2px 6px rgba(0,0,0,0.15); 
    }
    .pub-header { 
      font-size:18px; 
      font-weight:bold; 
      cursor:pointer; 
    }
    .questions-container { 
      margin-top:10px; 
      padding:12px 16px; 
      border-radius:10px; 
      background-color:#fff;
    }
    .question { margin-bottom:12px; }
    .submit-btn {
      padding:10px 20px;
      font-size:16px;
      cursor:pointer;
      border-radius:5px;
      border:none;
      margin-top:10px;
      background:#4CAF50;
      color:white;
    }
  </style>
</head>
<body>
  <h1>Pub Ratings</h1>
  <div id="pubsContainer"></div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwhPja-Er9ICDhwDTs_jy-u23HSLOateqttrhcQDgUYEVLBUHTfIljG2WO87P9TFZjrEA/exec";

    let pubData = {};

    async function loadPubData() {
      const res = await fetch(WEBAPP_URL + "?action=getPubData");
      pubData = await res.json();
      renderPubs(pubData);
    }

    function renderPubs(data) {
      const container = document.getElementById("pubsContainer");
      container.innerHTML = "";

      data.pubs.forEach(pubName => {
        const card = document.createElement("div");
        card.className = "pub-card";

        const header = document.createElement("div");
        header.className = "pub-header";
        header.textContent = pubName;

        const qContainer = document.createElement("div");
        qContainer.className = "questions-container";

        // render questions
        data.labels.forEach((label, i) => {
          const div = document.createElement("div");
          div.className = "question";
          div.innerHTML = `<label>${label}: 
            <input type="text" data-index="${i}"></label>`;
          qContainer.appendChild(div);
        });

        // submit button
        const submitBtn = document.createElement("button");
        submitBtn.className = "submit-btn";
        submitBtn.textContent = "Submit";

        // attach click handler directly
        submitBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();

          const answers = Array.from(qContainer.querySelectorAll("input"))
            .map(inp => inp.value);

          const payload = {
            pubName: pubName,
            reviewer: "You", // adjust if you want dynamic reviewer
            answers: answers
          };

          console.log("Submitting", payload);

          try {
            const res = await fetch(WEBAPP_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const result = await res.json();
            console.log("Response:", result);
            if (result.status === "success") {
              alert("Saved!");
            } else {
              alert("Error: " + result.message);
            }
          } catch(err) {
            console.error("Fetch error:", err);
            alert("Failed to submit, check console");
          }
        });

        qContainer.appendChild(submitBtn);
        card.appendChild(header);
        card.appendChild(qContainer);
        container.appendChild(card);
      });
    }

    loadPubData();
  </script>
</body>
</html>
